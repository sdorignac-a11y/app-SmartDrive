<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Drop Calculator Fortnite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      padding: 1rem;
      box-sizing: border-box;
    }
    h1 {
      font-size: 1.6rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .sub {
      color: #9ca3af;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .wrapper {
      background: #020617;
      border-radius: 1rem;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 1rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      max-width: 900px;
      width: 100%;
    }
    #canvasContainer {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    canvas {
      border-radius: 0.75rem;
      border: 1px solid rgba(148,163,184,0.4);
      touch-action: manipulation;
      background: #000;
      max-width: 100%;
      height: auto;
    }
    .info {
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .info strong {
      color: #38bdf8;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 0.8rem;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg,#38bdf8,#a855f7);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .pill {
      font-size: 0.8rem;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: #9ca3af;
    }
    @media (max-width: 600px) {
      canvas {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <h1>Drop Calculator – Fortnite</h1>
  <p class="sub">
    Click izquierdo: puntos · Ruedita: zoom · Click derecho + arrastrar: mover mapa
  </p>

  <div class="wrapper">
    <div id="canvasContainer">
      <canvas id="mapCanvas" width="600" height="600"></canvas>
    </div>

    <div class="info" id="infoText">
      Hacé clic en el mapa para marcar el <strong>inicio del bus</strong>.
    </div>

    <div class="row">
      <span class="pill" id="estadoPill">Puntos marcados: 0 / 3</span>
      <button id="resetBtn">Reiniciar</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("mapCanvas");
    const ctx = canvas.getContext("2d");
    const infoText = document.getElementById("infoText");
    const estadoPill = document.getElementById("estadoPill");
    const resetBtn = document.getElementById("resetBtn");

    let busStart = null; // coords en el mapa (espacio del mapa)
    let busEnd = null;
    let spot = null;

    // === Mapa real de Fortnite ===
    const img = new Image();
    img.src = "mapa.png"; // poné acá tu archivo (png/jpg/webp)
    img.onload = () => {
      // Ajustamos el canvas al tamaño real del mapa
      canvas.width = img.width;
      canvas.height = img.height;
      dibujarOverlay();
    };

    // === Zoom y pan ===
    let scale = 1;
    const MIN_SCALE = 0.6;
    const MAX_SCALE = 3;
    let offsetX = 0;
    let offsetY = 0;

    let isPanning = false;
    let startPanX = 0;
    let startPanY = 0;
    let startOffsetX = 0;
    let startOffsetY = 0;

    // Evitar menú contextual para click derecho
    canvas.addEventListener("contextmenu", (e) => e.preventDefault());

    // Zoom con ruedita (scroll)
    canvas.addEventListener("wheel", (e) => {
      e.preventDefault();

      const rect = canvas.getBoundingClientRect();
      // Coordenadas del mouse en el canvas (tener en cuenta CSS scale)
      const xCanvas = (e.clientX - rect.left) * (canvas.width / rect.width);
      const yCanvas = (e.clientY - rect.top) * (canvas.height / rect.height);

      // Coordenadas en el espacio del mapa (antes del cambio de zoom)
      const worldX = (xCanvas - offsetX) / scale;
      const worldY = (yCanvas - offsetY) / scale;

      const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
      let newScale = scale * zoomFactor;

      if (newScale < MIN_SCALE) newScale = MIN_SCALE;
      if (newScale > MAX_SCALE) newScale = MAX_SCALE;

      scale = newScale;

      // Ajustar offset para que el punto bajo el cursor quede "fijo"
      offsetX = xCanvas - worldX * scale;
      offsetY = yCanvas - worldY * scale;

      dibujarOverlay();
    });

    // Pan con click derecho
    canvas.addEventListener("mousedown", (e) => {
      if (e.button === 2) { // botón derecho
        isPanning = true;
        const rect = canvas.getBoundingClientRect();
        startPanX = e.clientX;
        startPanY = e.clientY;
        startOffsetX = offsetX;
        startOffsetY = offsetY;
      }
    });

    canvas.addEventListener("mousemove", (e) => {
      if (!isPanning) return;
      const rect = canvas.getBoundingClientRect();
      const dxClient = e.clientX - startPanX;
      const dyClient = e.clientY - startPanY;

      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

      offsetX = startOffsetX + dxClient * scaleX;
      offsetY = startOffsetY + dyClient * scaleY;

      dibujarOverlay();
    });

    window.addEventListener("mouseup", () => {
      isPanning = false;
    });

    // Dibuja mapa + línea del bus + puntos
    function dibujarOverlay() {
      if (!img.complete) return;

      // Reset de transform y limpieza
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Aplicar zoom + pan
      ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);

      // Fondo: mapa
      ctx.drawImage(img, 0, 0, img.width, img.height);

      // Línea del bus
      if (busStart && busEnd) {
        ctx.strokeStyle = "#38bdf8";
        ctx.lineWidth = 2 / scale; // más fino al hacer zoom
        ctx.beginPath();
        ctx.moveTo(busStart.x, busStart.y);
        ctx.lineTo(busEnd.x, busEnd.y);
        ctx.stroke();
      }

      // Puntos
      dibujarPunto(busStart, "#22c55e", "S"); // Start
      dibujarPunto(busEnd, "#ef4444", "E");   // End
      dibujarPunto(spot, "#eab308", "P");     // Spot

      // Punto de salto (si ya tenemos los 3)
      if (busStart && busEnd && spot) {
        const { jumpPoint, porcentaje } = calcularPuntoSalto(busStart, busEnd, spot);
        dibujarPunto(jumpPoint, "#a855f7", "J");

        infoText.innerHTML =
          `Punto de salto calculado:<br>
          &bull; Tirate aproximadamente al <strong>${porcentaje.toFixed(1)}%</strong> del recorrido del bus.<br>
          &bull; Coordenadas de salto (en el mapa): <strong>(${jumpPoint.x.toFixed(0)}, ${jumpPoint.y.toFixed(0)})</strong>.`;
      }
    }

    function dibujarPunto(p, color, label) {
      if (!p) return;
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 6 / scale, 0, Math.PI * 2); // 6/scale = tamaño más constante
      ctx.fill();

      ctx.fillStyle = "#e5e7eb";
      ctx.font = `${10 / scale}px system-ui`;
      ctx.fillText(label, p.x + 8 / scale, p.y - 8 / scale);
    }

    function calcularPuntoSalto(busStart, busEnd, spot) {
      const vx = busEnd.x - busStart.x;
      const vy = busEnd.y - busStart.y;

      const wx = spot.x - busStart.x;
      const wy = spot.y - busStart.y;

      const denom = vx*vx + vy*vy; // |SE|^2

      if (denom === 0) {
        return {
          jumpPoint: { x: busStart.x, y: busStart.y },
          t: 0,
          porcentaje: 0
        };
      }

      let t = (wx*vx + wy*vy) / denom;

      // limitar t al segmento [0,1]
      if (t < 0) t = 0;
      if (t > 1) t = 1;

      const jumpX = busStart.x + vx * t;
      const jumpY = busStart.y + vy * t;

      return {
        jumpPoint: { x: jumpX, y: jumpY },
        t,
        porcentaje: t * 100
      };
    }

    function actualizarEstado() {
      let count = 0;
      if (busStart) count++;
      if (busEnd) count++;
      if (spot) count++;
      estadoPill.textContent = `Puntos marcados: ${count} / 3`;

      if (!busStart) {
        infoText.innerHTML = 'Hacé clic en el mapa para marcar el <strong>inicio del bus</strong>.';
      } else if (!busEnd) {
        infoText.innerHTML = 'Ahora marcá el <strong>final del bus</strong>.';
      } else if (!spot) {
        infoText.innerHTML = 'Por último, marcá el <strong>spot donde querés caer</strong>.';
      }
    }

    // Click izquierdo para marcar puntos (en coordenadas del mapa)
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const xCanvas = (e.clientX - rect.left) * (canvas.width / rect.width);
      const yCanvas = (e.clientY - rect.top) * (canvas.height / rect.height);

      // Convertir de coords pantalla → coords mapa (inverso de transform)
      const worldX = (xCanvas - offsetX) / scale;
      const worldY = (yCanvas - offsetY) / scale;

      if (!busStart) {
        busStart = { x: worldX, y: worldY };
      } else if (!busEnd) {
        busEnd = { x: worldX, y: worldY };
      } else if (!spot) {
        spot = { x: worldX, y: worldY };
      } else {
        // Si ya están los tres, volvemos a empezar por comodidad:
        busStart = { x: worldX, y: worldY };
        busEnd = null;
        spot = null;
      }

      actualizarEstado();
      dibujarOverlay();
    });

    resetBtn.addEventListener("click", () => {
      busStart = null;
      busEnd = null;
      spot = null;
      actualizarEstado();
      dibujarOverlay();
    });

    // Inicial (por si tarda en cargar la imagen)
    actualizarEstado();
  </script>
</body>
</html>
